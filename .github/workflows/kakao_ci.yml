name: Kakao CI - Build & Release

on:
  push:
    branches: [main, fix/cd-security]
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options: [patch, minor, major]

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    env:
      INFISICAL_SERVICE_TOKEN: ${{ secrets.INFISICAL_SERVICE_TOKEN }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - run: npm ci
      - run: npm run lint
      - run: npm run test
      - run: npm run build

      - name: Calculate version
        id: version
        run: |
          LATEST=$(git describe --tags --abbrev=0 --match "v*" 2>/dev/null || echo "v0.0.0")
          IFS='.' read -r MAJOR MINOR PATCH <<< "${LATEST#v}"
          BUMP="${{ github.event.inputs.version_bump || 'patch' }}"

          case "$BUMP" in
            major) NEW="$((MAJOR+1)).0.0" ;;
            minor) NEW="${MAJOR}.$((MINOR+1)).0" ;;
            *)     NEW="${MAJOR}.${MINOR}.$((PATCH+1))" ;;
          esac

          echo "new=v${NEW}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ ë²„ì „: v${NEW}"

      - uses: docker/setup-buildx-action@v3

      - name: Install Infisical CLI
        run: |
          curl -1sLf 'https://artifacts-cli.infisical.com/setup.deb.sh' | sudo -E bash
          sudo apt-get update && sudo apt-get install -y infisical

      - name: Load secrets
        run: |
          infisical export --env=prod --token="$INFISICAL_SERVICE_TOKEN" --format=json --output-file=/tmp/secrets.json --silent
          node <<'EOF'
          const fs = require('node:fs');
          const secrets = JSON.parse(fs.readFileSync('/tmp/secrets.json', 'utf8'));
          const keys = ['KCR_REGISTRY', 'KCR_IMAGE', 'KAKAO_ACCESS_KEY', 'KAKAO_SECRET_KEY'];
          for (const { key, value } of secrets) {
            if (!keys.includes(key)) continue;
            const v = (value ?? '').trim();
            if (!v) throw new Error(`Empty secret: ${key}`);
            console.log(`::add-mask::${v}`);
            fs.appendFileSync(process.env.GITHUB_ENV, `${key}=${v}\n`);
          }
          EOF
          rm -f /tmp/secrets.json

      - name: Login to KCR
        run: echo "${{ env.KAKAO_SECRET_KEY }}" | docker login "${{ env.KCR_REGISTRY }}" -u "${{ env.KAKAO_ACCESS_KEY }}" --password-stdin

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.KCR_IMAGE }}:latest
            ${{ env.KCR_IMAGE }}:${{ steps.version.outputs.new }}
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.new }}
          name: Release ${{ steps.version.outputs.new }}
          generate_release_notes: true
