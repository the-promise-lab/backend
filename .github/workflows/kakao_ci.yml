name: Kakao CI

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    env:
      INFISICAL_SERVICE_TOKEN: ${{ secrets.INFISICAL_SERVICE_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies with retry
        run: |
          n=0
          exit_code=0
          until [ $n -ge 5 ]
          do
            npm ci
            exit_code=$?
            if [ $exit_code -eq 0 ]; then
              break
            fi
            n=$(($n+1))
            echo "npm ci failed with exit code $exit_code. Retrying in 10 seconds..."
            sleep 10
          done
          if [ $exit_code -ne 0 ]; then
            echo "npm ci failed after 5 attempts."
          fi
          exit $exit_code

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm run test

      - name: Run build
        run: npm run build

      - name: Get current version (main branch only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: current_version
        run: |
          if git tag -l "v*" | grep -q "^v"; then
            LATEST_TAG=$(git describe --tags --abbrev=0 --match "v*" 2>/dev/null || echo "v0.0.0")
          else
            LATEST_TAG="v0.0.0"
          fi
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "í˜„ì¬ ìµœì‹  íƒœê·¸: $LATEST_TAG"

      - name: Calculate new version (main branch only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: new_version
        run: |
          LATEST_TAG="${{ steps.current_version.outputs.latest_tag }}"
          VERSION=${LATEST_TAG#v}  # Remove 'v' prefix

          IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]:-0}
          PATCH=${VERSION_PARTS[2]:-0}

          # Determine version bump type
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            BUMP_TYPE="${{ github.event.inputs.version_bump }}"
          else
            BUMP_TYPE="patch"
          fi

          # Calculate new version
          if [[ "$BUMP_TYPE" == "major" ]]; then
            NEW_MAJOR=$((MAJOR + 1))
            NEW_MINOR=0
            NEW_PATCH=0
          elif [[ "$BUMP_TYPE" == "minor" ]]; then
            NEW_MAJOR=$MAJOR
            NEW_MINOR=$((MINOR + 1))
            NEW_PATCH=0
          else
            NEW_MAJOR=$MAJOR
            NEW_MINOR=$MINOR
            NEW_PATCH=$((PATCH + 1))
          fi

          NEW_VERSION="$NEW_MAJOR.$NEW_MINOR.$NEW_PATCH"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "ìƒˆ ë²„ì „: v$NEW_VERSION"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Infisical CLI (main branch only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          set -Eeuo pipefail
          curl -1sLf 'https://artifacts-cli.infisical.com/setup.deb.sh' | sudo -E bash
          sudo apt-get update
          sudo apt-get install -y infisical

      - name: Load secrets from Infisical (main branch only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          set -Eeuo pipefail
          infisical export \
            --env=prod \
            --token="$INFISICAL_SERVICE_TOKEN" \
            --format=json \
            --output-file=/tmp/infisical.json \
            --silent
          node <<'NODE'
          const fs = require('node:fs');
          const envFile = process.env.GITHUB_ENV;
          if (!envFile) {
            process.exit(0);
          }
          const entries = JSON.parse(fs.readFileSync('/tmp/infisical.json', 'utf8'));
          for (const entry of entries) {
            const key = String(entry.key || '').trim();
            if (!key) continue;
            const value = String(entry.value ?? '');
            if (value.includes('\n') || value.includes('\r')) {
              const delimiter = `EOF_${key}_${Date.now()}`;
              fs.appendFileSync(envFile, `${key}<<${delimiter}\n${value}\n${delimiter}\n`, 'utf8');
            } else {
              fs.appendFileSync(envFile, `${key}=${value.replace(/\r?\n/g, '')}\n`, 'utf8');
            }
          }
          NODE
          rm -f /tmp/infisical.json

      - name: Login to Kakao Container Registry (main branch only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.KCR_REGISTRY }}
          username: ${{ env.KAKAO_ACCESS_KEY }}
          password: ${{ env.KAKAO_SECRET_KEY }}

      - name: Build and push Docker image (main branch)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.KCR_IMAGE }}:latest
            ${{ env.KCR_IMAGE }}:v${{ steps.new_version.outputs.new_version }}
          platforms: linux/amd64
          cache-from: |
            type=gha
          cache-to: |
            type=gha,mode=max

      - name: Test Docker build (PR only)
        if: github.event_name == 'pull_request'
        run: |
          docker build -t test-image .
          echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì„±ê³µ!"

      - name: Check if tag already exists (main branch only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: check_tag
        run: |
          TARGET_TAG="v${{ steps.new_version.outputs.new_version }}"
          if git ls-remote --tags origin "$TARGET_TAG" | grep -q "refs/tags/$TARGET_TAG"; then
            echo "tag_exists=true" >> "$GITHUB_OUTPUT"
            echo "Tag $TARGET_TAG already exists. Skipping tag and release steps."
          else
            echo "tag_exists=false" >> "$GITHUB_OUTPUT"
            echo "Tag $TARGET_TAG does not exist yet. Continuing with tag creation."
          fi

      - name: Create Git tag (main branch only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.check_tag.outputs.tag_exists != 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a "v${{ steps.new_version.outputs.new_version }}" -m "Release v${{ steps.new_version.outputs.new_version }}"
          git push origin "v${{ steps.new_version.outputs.new_version }}"

      - name: Create GitHub Release (main branch only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.check_tag.outputs.tag_exists != 'true'
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: v${{ steps.new_version.outputs.new_version }}
          name: Release v${{ steps.new_version.outputs.new_version }}
          body: |
            ## ğŸš€ ìƒˆë¡œìš´ ë¦´ë¦¬ì¦ˆ: v${{ steps.new_version.outputs.new_version }}

            ### ğŸ“¦ Docker ì´ë¯¸ì§€ ì‚¬ìš©ë²•
            ```bash
            # ìµœì‹  ë²„ì „
            docker run -p 3000:3000 ${{ env.KCR_IMAGE }}:latest

            # íŠ¹ì • ë²„ì „ (ê¶Œì¥)
            docker run -p 3000:3000 ${{ env.KCR_IMAGE }}:v${{ steps.new_version.outputs.new_version }}
            ```

            ### ğŸ”— ì ‘ì† ì •ë³´
            - **API**: http://localhost:3000/api
            - **Health Check**: http://localhost:3000/api/health
            - **API ë¬¸ì„œ**: http://localhost:3000/api/docs

            ### ğŸ”„ ë³€ê²½ì‚¬í•­
            ì´ ë¦´ë¦¬ì¦ˆëŠ” main ë¸Œëœì¹˜ì˜ ìµœì‹  ë³€ê²½ì‚¬í•­ì„ í¬í•¨í•©ë‹ˆë‹¤.

            ### ğŸ“‹ ë¹Œë“œ ì •ë³´
            - **ì»¤ë°‹**: ${{ github.sha }}
            - **ì‘ì„±ì**: ${{ github.actor }}
            - **Node.js**: 22.x
            - **í”Œë«í¼**: linux/amd64
          draft: false
          prerelease: false
