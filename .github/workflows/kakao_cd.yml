name: Kakao CD

on:
  workflow_run:
    workflows:
      - Kakao CI
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: false
        default: 'latest'
        type: string

permissions:
  contents: read

concurrency:
  group: cd-kakao-production
  cancel-in-progress: false

jobs:
  deploy:
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main')
    runs-on: ubuntu-latest
    env:
      INFISICAL_SERVICE_TOKEN: ${{ secrets.INFISICAL_SERVICE_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine image tag
        id: determine_image_tag
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const eventName = context.eventName;
            if (eventName === 'workflow_dispatch') {
              const manualTag = (context.payload.inputs?.image_tag ?? '').trim();
              const imageTag = manualTag.length > 0 ? manualTag : 'latest';
              core.info(`Using manual image tag: ${imageTag}`);
              core.setOutput('image_tag', imageTag);
              core.exportVariable('IMAGE_TAG', imageTag);
              return;
            }

            try {
              const response = await github.rest.repos.getLatestRelease({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              const latestTag = response.data.tag_name;
              core.info(`Using latest release tag: ${latestTag}`);
              core.setOutput('image_tag', latestTag);
              core.exportVariable('IMAGE_TAG', latestTag);
            } catch (error) {
              core.warning(`Failed to fetch latest release: ${error.message}`);
              core.setOutput('image_tag', 'latest');
              core.exportVariable('IMAGE_TAG', 'latest');
            }

      - name: Install Infisical CLI
        run: |
          set -Eeuo pipefail
          curl -1sLf 'https://artifacts-cli.infisical.com/setup.deb.sh' | sudo -E bash
          sudo apt-get update
          sudo apt-get install -y infisical

      - name: Load secrets from Infisical
        run: |
          set -Eeuo pipefail
          infisical export \
            --env=prod \
            --token="$INFISICAL_SERVICE_TOKEN" \
            --format=json \
            --output-file=/tmp/infisical.json \
            --silent
          node <<'NODE'
          const fs = require('node:fs');
          const envFile = process.env.GITHUB_ENV;
          if (!envFile) {
            process.exit(0);
          }
          const entries = JSON.parse(fs.readFileSync('/tmp/infisical.json', 'utf8'));
          for (const entry of entries) {
            const key = String(entry.key || '').trim();
            if (!key) continue;
            const value = String(entry.value ?? '');
            if (value.includes('\n') || value.includes('\r')) {
              const delimiter = `EOF_${key}_${Date.now()}`;
              fs.appendFileSync(envFile, `${key}<<${delimiter}\n${value}\n${delimiter}\n`, 'utf8');
            } else {
              fs.appendFileSync(envFile, `${key}=${value.replace(/\r?\n/g, '')}\n`, 'utf8');
            }
          }
          NODE
          rm -f /tmp/infisical.json

      - name: Deploy to Kakao Cloud
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.KAKAO_CLOUD_HOST }}
          username: ${{ env.KAKAO_CLOUD_USER }}
          key: ${{ env.KAKAO_CLOUD_SSH_KEY }}
          port: 22
          timeout: 500s
          command_timeout: 500s
          envs: KCR_REGISTRY,KCR_IMAGE,KAKAO_ACCESS_KEY,KAKAO_SECRET_KEY,INFISICAL_SERVICE_TOKEN,IMAGE_TAG
          script: |
            set -Eeuo pipefail
            IFS=$'\n\t'
            trap 'code=$?; echo "â— ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜(code=$code)"; exit $code' ERR

            echo "ğŸš€ ë°°í¬ ì‹œì‘: ${KCR_IMAGE}:$IMAGE_TAG"

            # prerequisites
            if ! command -v docker &> /dev/null; then
              echo "âŒ Dockerê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
              exit 1
            fi

            if ! command -v curl &> /dev/null; then
              echo "âŒ curlì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
              exit 1
            fi

            # login + pull
            docker login "${KCR_REGISTRY}" --username "${KAKAO_ACCESS_KEY}" --password "${KAKAO_SECRET_KEY}"
            if docker pull "${KCR_IMAGE}:$IMAGE_TAG"; then
              echo "âœ… ì´ë¯¸ì§€ pull ì„±ê³µ: ${KCR_IMAGE}:$IMAGE_TAG"
            else
              echo "âŒ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨!"
              docker images
              exit 1
            fi

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ í™•ì¸ (ë¬´ì¤‘ë‹¨ ë°°í¬ë¥¼ ìœ„í•´ ì•„ì§ ì œê±°í•˜ì§€ ì•ŠìŒ)
            CONTAINER_NAME="thepromise-backend"

            # ë©”ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸ (ì œê±°í•˜ì§€ ì•Šê³  ì •ë³´ë§Œ ìˆ˜ì§‘)
            OLD_CONTAINER_ID="$(docker ps -aq -f name="^${CONTAINER_NAME}$")"
            if [ -n "$OLD_CONTAINER_ID" ]; then
              echo "ğŸ”„ ê¸°ì¡´ ë©”ì¸ ì»¨í…Œì´ë„ˆ ë°œê²¬: $OLD_CONTAINER_ID (ìœ ì§€ ì¤‘ - ë¬´ì¤‘ë‹¨ ë°°í¬)"
            else
              echo "â„¹ï¸ ê¸°ì¡´ ë©”ì¸ ì»¨í…Œì´ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤ (ì²« ë°°í¬)"
            fi

            # ì„ì‹œ(-new) ì»¨í…Œì´ë„ˆë§Œ ì •ë¦¬ (ì´ì „ ì‹¤íŒ¨ ë°°í¬ì˜ ì”ì—¬ë¬¼)
            NEW_CONTAINER_ID_OLD="$(docker ps -aq -f name="^${CONTAINER_NAME}-new$")"
            if [ -n "$NEW_CONTAINER_ID_OLD" ]; then
              echo "ğŸ§¹ ì´ì „ ì‹¤íŒ¨ ë°°í¬ì˜ ì„ì‹œ ì»¨í…Œì´ë„ˆ ë°œê²¬: $NEW_CONTAINER_ID_OLD"
              if [ "$(docker inspect -f '{{.State.Running}}' "$NEW_CONTAINER_ID_OLD" 2>/dev/null)" = "true" ]; then
                echo "ğŸ›‘ ì„ì‹œ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
                docker stop "$NEW_CONTAINER_ID_OLD"
              fi
              echo "ğŸ—‘ï¸ ì„ì‹œ ì»¨í…Œì´ë„ˆ ì œê±° ì¤‘..."
              docker rm "$NEW_CONTAINER_ID_OLD"
              echo "âœ… ì„ì‹œ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì™„ë£Œ"
            fi

            # Blue/Green ë°°í¬ë¥¼ ìœ„í•œ í¬íŠ¸ ê²°ì •
            CURRENT_PORT=3000
            NEW_PORT=3001

            # Nginx ì„¤ì •ì—ì„œ backend_active ì—…ìŠ¤íŠ¸ë¦¼ í¬íŠ¸ë¥¼ íŒŒì‹±
            NGINX_CONFIG="/etc/nginx/sites-available/thepromise-backend"
            if [ -f "$NGINX_CONFIG" ]; then
              CURRENT_PORT="$(awk '/upstream[[:space:]]+backend_active[[:space:]]*{/,/}/ { if ($1=="server") { if (match($0,/127\.0\.0\.1:([0-9]+)/,m)) { print m[1]; exit } } }' "$NGINX_CONFIG" || true)"
            fi
            if [ "$CURRENT_PORT" = "3000" ]; then
              NEW_PORT=3001
            elif [ "$CURRENT_PORT" = "3001" ]; then
              NEW_PORT=3000
            else
              echo "âš ï¸ backend_active í¬íŠ¸ë¥¼ íŒŒì•…í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’(3000->3001)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
              CURRENT_PORT=3000
              NEW_PORT=3001
            fi

            echo "ğŸ”„ í˜„ì¬ í¬íŠ¸: $CURRENT_PORT, ìƒˆ í¬íŠ¸: $NEW_PORT"

            # env-file for container (token only; project id from .infisical.json in image)
            cat > /tmp/.env << EOF
            INFISICAL_SERVICE_TOKEN=${INFISICAL_SERVICE_TOKEN}
            INFISICAL_ENV=prod
            EOF

            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ì„ì‹œ ì´ë¦„ìœ¼ë¡œ)
            echo "ğŸ†• ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘ ì¤‘ (í¬íŠ¸: $NEW_PORT)..."
            NEW_CONTAINER_ID=$(docker run -d \
              --name "${CONTAINER_NAME}-new" \
              -p 127.0.0.1:$NEW_PORT:3000 \
              --restart unless-stopped \
              --env-file /tmp/.env \
              -e NODE_ENV=production \
              "${KCR_IMAGE}:$IMAGE_TAG")

            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ì •ë¦¬ (ë³´ì•ˆ)
            rm -f /tmp/.env

            echo "â³ ìƒˆ ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘..."
            echo "ğŸ” ì»¨í…Œì´ë„ˆ ID: $NEW_CONTAINER_ID"

            # í—¬ìŠ¤ì²´í¬ (ìµœëŒ€ 60ì´ˆ ëŒ€ê¸°)
            HEALTH_CHECK_ATTEMPTS=0
            MAX_ATTEMPTS=20

            while [ $HEALTH_CHECK_ATTEMPTS -lt $MAX_ATTEMPTS ]; do
              # ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ ë¨¼ì € í™•ì¸
              if [ "$(docker inspect -f '{{.State.Running}}' "$NEW_CONTAINER_ID" 2>/dev/null)" != "true" ]; then
                echo "âŒ ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë˜ì§€ ì•Šê³  ìˆìŠµë‹ˆë‹¤!"
                break
              fi
              
              if curl -f --max-time 3 http://localhost:$NEW_PORT/api/health > /dev/null 2>&1; then
                echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
                break
              fi
              
              HEALTH_CHECK_ATTEMPTS=$((HEALTH_CHECK_ATTEMPTS + 1))
              echo "â³ í—¬ìŠ¤ì²´í¬ ì‹œë„ $HEALTH_CHECK_ATTEMPTS/$MAX_ATTEMPTS..."
              sleep 3
            done

            # í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ì‹œ ë¡¤ë°±
            if [ $HEALTH_CHECK_ATTEMPTS -eq $MAX_ATTEMPTS ]; then
              echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨! ìƒˆ ì»¨í…Œì´ë„ˆë¥¼ ì œê±°í•©ë‹ˆë‹¤."
              echo "ğŸªµ ìƒˆ ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ìµœê·¼ 200ì¤„):"
              docker logs --tail 200 "$NEW_CONTAINER_ID" || true
              docker stop "$NEW_CONTAINER_ID"
              docker rm "$NEW_CONTAINER_ID"
              echo "ğŸ’¥ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
              exit 1
            fi

            # Nginxë¥¼ í†µí•œ íŠ¸ë˜í”½ ì „í™˜
            echo "ğŸ”„ Nginx íŠ¸ë˜í”½ ì „í™˜ ì¤‘..."
            SWITCH_SCRIPT="/opt/thepromise/scripts/switch-backend.sh"
            if [ ! -x "$SWITCH_SCRIPT" ]; then
              echo "âŒ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì‹¤í–‰ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤: $SWITCH_SCRIPT"
              echo "   /opt/thepromise/scripts ë””ë ‰í† ë¦¬ì— switch-backend.sh ë°°í¬ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ì„¸ìš”."
              exit 1
            fi
            sudo "$SWITCH_SCRIPT" "$NEW_PORT" "$CURRENT_PORT"

            # ì „í™˜ ì„±ê³µ í›„ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì œê±° (ì´ë¦„ìœ¼ë¡œ ì¬íƒìƒ‰í•˜ì—¬ ì‹ ë¢°ì„± í–¥ìƒ)
            EXISTING_CANONICAL_ID="$(docker ps -aq -f name="^${CONTAINER_NAME}$")"
            if [ -n "$EXISTING_CANONICAL_ID" ] && [ "$EXISTING_CANONICAL_ID" != "$NEW_CONTAINER_ID" ]; then
              echo "ğŸ§¹ ì´ì „ ì»¨í…Œì´ë„ˆ ì œê±° ì¤‘..."
              if [ "$(docker inspect -f '{{.State.Running}}' "$EXISTING_CANONICAL_ID" 2>/dev/null)" = "true" ]; then
                docker stop "$EXISTING_CANONICAL_ID" 2>/dev/null || true
              fi
              docker rm "$EXISTING_CANONICAL_ID" 2>/dev/null || true
            fi

            # ìƒˆ ì»¨í…Œì´ë„ˆ ì´ë¦„ ë³€ê²½
            docker rename "${CONTAINER_NAME}-new" "$CONTAINER_NAME"

            # dangling ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -f

            # ë°°í¬ ì™„ë£Œ ì •ë³´ ì¶œë ¥
            echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
            echo "ğŸ“Š ë°°í¬ ì •ë³´:"
            echo "   - ì´ë¯¸ì§€: ${KCR_IMAGE}:$IMAGE_TAG"
            echo "   - ì»¨í…Œì´ë„ˆ: $NEW_CONTAINER_ID"
            echo "   - í¬íŠ¸: $NEW_PORT (Nginx í†µí•´ 80ìœ¼ë¡œ ì „ë‹¬)"
            echo "   - ìƒíƒœ: $(docker inspect --format='{{.State.Status}}' $CONTAINER_NAME)"

            # ìµœì¢… ìƒíƒœ í™•ì¸
            echo "ğŸ” ìµœì¢… ìƒíƒœ í™•ì¸:"
            docker ps -f name=$CONTAINER_NAME --format "table {{.Names}}	{{.Status}}	{{.Ports}}"

      - name: Verify deployment
        if: success()
        run: |
          echo "âœ… ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ·ï¸ ë°°í¬ëœ íƒœê·¸: ${IMAGE_TAG:-latest}"
          echo "ğŸŒ ì„œë¹„ìŠ¤ URL: http://${{ env.KAKAO_CLOUD_HOST }} (Nginx ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ)"
          echo "ğŸ” í—¬ìŠ¤ì²´í¬: http://${{ env.KAKAO_CLOUD_HOST }}/api/health"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "âŒ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ íŒŒì•…í•˜ì„¸ìš”."
          echo "ğŸ”„ í•„ìš”ì‹œ ì´ì „ ë²„ì „ìœ¼ë¡œ ìˆ˜ë™ ë¡¤ë°±í•˜ì„¸ìš”."
