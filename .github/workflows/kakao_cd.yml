name: Kakao CD

on:
  workflow_run:
    workflows: [Kakao CI - Build & Release]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: false
        default: 'latest'
        type: string

permissions:
  contents: read

concurrency:
  group: cd-kakao-production
  cancel-in-progress: false

jobs:
  deploy:
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')
    runs-on: ubuntu-latest
    env:
      INFISICAL_SERVICE_TOKEN: ${{ secrets.INFISICAL_SERVICE_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine image tag
        id: tag
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === 'workflow_dispatch') {
              const tag = (context.payload.inputs?.image_tag ?? '').trim() || 'latest';
              core.setOutput('value', tag);
              return;
            }
            try {
              const { data } = await github.rest.repos.getLatestRelease({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              core.setOutput('value', data.tag_name);
            } catch {
              core.setOutput('value', 'latest');
            }

      - name: Install Infisical CLI
        run: |
          curl -1sLf 'https://artifacts-cli.infisical.com/setup.deb.sh' | sudo -E bash
          sudo apt-get update && sudo apt-get install -y infisical

      - name: Load secrets from Infisical
        run: |
          infisical export --env=prod --token="$INFISICAL_SERVICE_TOKEN" --format=json --output-file=/tmp/secrets.json --silent
          node <<'EOF'
          const fs = require('node:fs');
          const secrets = JSON.parse(fs.readFileSync('/tmp/secrets.json', 'utf8'));
          const envFile = process.env.GITHUB_ENV;

          const keys = ['KCR_REGISTRY', 'KCR_IMAGE', 'KAKAO_ACCESS_KEY', 'KAKAO_SECRET_KEY', 'KAKAO_CLOUD_HOST', 'KAKAO_CLOUD_USER'];

          for (const { key, value } of secrets) {
            if (keys.includes(key)) {
              const v = (value ?? '').trim();
              if (!v) throw new Error(`Empty secret: ${key}`);
              console.log(`::add-mask::${v}`);
              fs.appendFileSync(envFile, `${key}=${v}\n`);
            }
            if (key === 'KAKAO_CLOUD_SSH_KEY') {
              const v = (value ?? '').replace(/\r\n/g, '\n');
              if (!v.trim()) throw new Error('Empty secret: KAKAO_CLOUD_SSH_KEY');
              v.split('\n').filter(l => l.trim()).forEach(l => console.log(`::add-mask::${l}`));
              const delim = `SSH_KEY_${Math.random().toString(16).slice(2)}`;
              fs.appendFileSync(envFile, `KAKAO_CLOUD_SSH_KEY<<${delim}\n${v}\n${delim}\n`);
            }
          }
          EOF
          rm -f /tmp/secrets.json

      - name: Upload deploy script
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.KAKAO_CLOUD_HOST }}
          username: ${{ env.KAKAO_CLOUD_USER }}
          key: ${{ env.KAKAO_CLOUD_SSH_KEY }}
          source: '.github/scripts/deploy.sh'
          target: '/tmp/deploy-scripts'
          strip_components: 2

      - name: Run deploy script
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.KAKAO_CLOUD_HOST }}
          username: ${{ env.KAKAO_CLOUD_USER }}
          key: ${{ env.KAKAO_CLOUD_SSH_KEY }}
          script: |
            chmod +x /tmp/deploy-scripts/deploy.sh
            /tmp/deploy-scripts/deploy.sh \
              "${{ steps.tag.outputs.value }}" \
              "${{ env.KCR_IMAGE }}" \
              "${{ env.KCR_REGISTRY }}" \
              "${{ env.KAKAO_ACCESS_KEY }}" \
              "${{ env.KAKAO_SECRET_KEY }}" \
              "${{ env.INFISICAL_SERVICE_TOKEN }}"
            rm -rf /tmp/deploy-scripts

      - name: Summary
        run: |
          echo "### ðŸš€ ë°°í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "- **ì´ë¯¸ì§€ íƒœê·¸**: ${{ steps.tag.outputs.value }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì„œë²„**: ${{ env.KAKAO_CLOUD_HOST }}" >> $GITHUB_STEP_SUMMARY
