name: CD

on:
  release:
    types: [published]
  push:
    branches:
      - feat/cd # ë°°í¬ í…ŒìŠ¤íŠ¸ ë¸Œëœì¹˜
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: false
        default: 'latest'
        type: string

permissions:
  contents: read

concurrency:
  group: cd-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script: |
          set -Eeuo pipefail
          IFS=$'\n\t'
          trap 'code=$?; echo "â— ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜(code=$code)"; exit $code' ERR
          
          # ë°°í¬í•  ì´ë¯¸ì§€ íƒœê·¸ ê²°ì •
          if [ "${{ github.event_name }}" = "release" ]; then
            IMAGE_TAG="${{ github.event.release.tag_name }}"
          else
            IMAGE_TAG="${{ github.event.inputs.image_tag || 'latest' }}"
          fi
          
          echo "ğŸš€ ë°°í¬ ì‹œì‘: thepromise2025/thepromise:$IMAGE_TAG"
          
          # Dockerê°€ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
          if ! command -v docker &> /dev/null; then
            echo "âŒ Dockerê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          # curl í™•ì¸ (í—¬ìŠ¤ì²´í¬ì— í•„ìš”)
          if ! command -v curl &> /dev/null; then
            echo "âŒ curlì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          # ìµœì‹  ì´ë¯¸ì§€ Pull
          echo "ğŸ“¦ Docker ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
          docker pull thepromise2025/thepromise:$IMAGE_TAG
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ í™•ì¸ (ì‹¤í–‰ ì¤‘ì´ê±°ë‚˜ ì¤‘ì§€ëœ ì»¨í…Œì´ë„ˆ ëª¨ë‘ í¬í•¨)
          CONTAINER_NAME="thepromise-backend"
          OLD_CONTAINER_ID="$(docker ps -aq -f name="^${CONTAINER_NAME}$")"
          
          if [ -n "$OLD_CONTAINER_ID" ]; then
            echo "ğŸ”„ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ë°œê²¬: $OLD_CONTAINER_ID"
            # ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸ í›„ ì¤‘ì§€
            if [ "$(docker inspect -f '{{.State.Running}}' "$OLD_CONTAINER_ID" 2>/dev/null)" = "true" ]; then
              echo "ğŸ›‘ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
              docker stop "$OLD_CONTAINER_ID"
            fi
            echo "ğŸ—‘ï¸ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì œê±° ì¤‘..."
            docker rm "$OLD_CONTAINER_ID"
            OLD_CONTAINER_ID=""
          fi
          
          # Blue/Green ë°°í¬ë¥¼ ìœ„í•œ í¬íŠ¸ ê²°ì •
          CURRENT_PORT=3000
          NEW_PORT=3001
          
          # Nginx ì„¤ì •ì—ì„œ backend_active ì—…ìŠ¤íŠ¸ë¦¼ í¬íŠ¸ë¥¼ íŒŒì‹±
          NGINX_CONFIG="/etc/nginx/sites-available/thepromise-backend"
          if [ -f "$NGINX_CONFIG" ]; then
            CURRENT_PORT="$(awk '/upstream[[:space:]]+backend_active[[:space:]]*{/,/}/ { if ($1=="server") { if (match($0,/127\.0\.0\.1:([0-9]+)/,m)) { print m[1]; exit } } }' "$NGINX_CONFIG" || true)"
          fi
          if [ "$CURRENT_PORT" = "3000" ]; then
            NEW_PORT=3001
          elif [ "$CURRENT_PORT" = "3001" ]; then
            NEW_PORT=3000
          else
            echo "âš ï¸ backend_active í¬íŠ¸ë¥¼ íŒŒì•…í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’(3000->3001)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
            CURRENT_PORT=3000
            NEW_PORT=3001
          fi
          
          echo "ğŸ”„ í˜„ì¬ í¬íŠ¸: $CURRENT_PORT, ìƒˆ í¬íŠ¸: $NEW_PORT"
          
          # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ì„ì‹œ ì´ë¦„ìœ¼ë¡œ)
          echo "ğŸ†• ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘ ì¤‘ (í¬íŠ¸: $NEW_PORT)..."
          NEW_CONTAINER_ID=$(docker run -d \
            --name "${CONTAINER_NAME}-new" \
            -p 127.0.0.1:$NEW_PORT:3000 \
            --restart unless-stopped \
            -e NODE_ENV=production \
            thepromise2025/thepromise:$IMAGE_TAG)
          
          echo "â³ ìƒˆ ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘..."
          
          # í—¬ìŠ¤ì²´í¬ (ìµœëŒ€ 60ì´ˆ ëŒ€ê¸°)
          HEALTH_CHECK_ATTEMPTS=0
          MAX_ATTEMPTS=20
          
          while [ $HEALTH_CHECK_ATTEMPTS -lt $MAX_ATTEMPTS ]; do
            if curl -f --max-time 3 http://localhost:$NEW_PORT/api/health > /dev/null 2>&1; then
              echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
              break
            fi
            
            HEALTH_CHECK_ATTEMPTS=$((HEALTH_CHECK_ATTEMPTS + 1))
            echo "â³ í—¬ìŠ¤ì²´í¬ ì‹œë„ $HEALTH_CHECK_ATTEMPTS/$MAX_ATTEMPTS..."
            sleep 3
          done
          
          # í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ì‹œ ë¡¤ë°±
          if [ $HEALTH_CHECK_ATTEMPTS -eq $MAX_ATTEMPTS ]; then
            echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨! ìƒˆ ì»¨í…Œì´ë„ˆë¥¼ ì œê±°í•©ë‹ˆë‹¤."
            echo "ğŸªµ ìƒˆ ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ìµœê·¼ 200ì¤„):"
            docker logs --tail 200 "$NEW_CONTAINER_ID" || true
            docker stop "$NEW_CONTAINER_ID"
            docker rm "$NEW_CONTAINER_ID"
            echo "ğŸ’¥ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
            exit 1
          fi
          
          # Nginxë¥¼ í†µí•œ íŠ¸ë˜í”½ ì „í™˜
          echo "ğŸ”„ Nginx íŠ¸ë˜í”½ ì „í™˜ ì¤‘..."
          SWITCH_SCRIPT="/opt/thepromise/scripts/switch-backend.sh"
          if [ ! -x "$SWITCH_SCRIPT" ]; then
            echo "âŒ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì‹¤í–‰ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤: $SWITCH_SCRIPT"
            echo "   /opt/thepromise/scripts ë””ë ‰í† ë¦¬ì— switch-backend.sh ë°°í¬ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ì„¸ìš”."
            exit 1
          fi
          "$SWITCH_SCRIPT" "$NEW_PORT" "$CURRENT_PORT"
          
          # ì „í™˜ ì„±ê³µ í›„ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì œê±° (ì´ë¦„ìœ¼ë¡œ ì¬íƒìƒ‰í•˜ì—¬ ì‹ ë¢°ì„± í–¥ìƒ)
          EXISTING_CANONICAL_ID="$(docker ps -aq -f name="^${CONTAINER_NAME}$")"
          if [ -n "$EXISTING_CANONICAL_ID" ] && [ "$EXISTING_CANONICAL_ID" != "$NEW_CONTAINER_ID" ]; then
            echo "ğŸ§¹ ì´ì „ ì»¨í…Œì´ë„ˆ ì œê±° ì¤‘..."
            if [ "$(docker inspect -f '{{.State.Running}}' "$EXISTING_CANONICAL_ID" 2>/dev/null)" = "true" ]; then
              docker stop "$EXISTING_CANONICAL_ID" 2>/dev/null || true
            fi
            docker rm "$EXISTING_CANONICAL_ID" 2>/dev/null || true
          fi

          # ìƒˆ ì»¨í…Œì´ë„ˆ ì´ë¦„ ë³€ê²½
          docker rename "${CONTAINER_NAME}-new" "$CONTAINER_NAME"
          
          # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
          echo "ğŸ§¹ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” Docker ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
          docker image prune -f
          
          # ë°°í¬ ì™„ë£Œ ì •ë³´ ì¶œë ¥
          echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
          echo "ğŸ“Š ë°°í¬ ì •ë³´:"
          echo "   - ì´ë¯¸ì§€: thepromise2025/thepromise:$IMAGE_TAG"
          echo "   - ì»¨í…Œì´ë„ˆ: $NEW_CONTAINER_ID"
          echo "   - í¬íŠ¸: $NEW_PORT (Nginx í†µí•´ 80ìœ¼ë¡œ ì „ë‹¬)"
          echo "   - ìƒíƒœ: $(docker inspect --format='{{.State.Status}}' $CONTAINER_NAME)"
          
          # ìµœì¢… ìƒíƒœ í™•ì¸
          echo "ğŸ” ìµœì¢… ìƒíƒœ í™•ì¸:"
          docker ps -f name=$CONTAINER_NAME --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

    - name: Verify deployment
      if: success()
      run: |
        echo "âœ… ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        if [ "${{ github.event_name }}" = "release" ]; then
          echo "ğŸ·ï¸ ë°°í¬ëœ ë²„ì „: ${{ github.event.release.tag_name }}"
        else
          echo "ğŸ·ï¸ ë°°í¬ëœ íƒœê·¸: ${{ github.event.inputs.image_tag || 'latest' }}"
        fi
        echo "ğŸŒ ì„œë¹„ìŠ¤ URL: http://43.200.235.94 (Nginx ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ)"
        echo "ğŸ” í—¬ìŠ¤ì²´í¬: http://43.200.235.94/api/health"

    - name: Notify deployment failure
      if: failure()
      run: |
        echo "âŒ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!"
        echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ íŒŒì•…í•˜ì„¸ìš”."
        echo "ğŸ”„ í•„ìš”ì‹œ ì´ì „ ë²„ì „ìœ¼ë¡œ ìˆ˜ë™ ë¡¤ë°±í•˜ì„¸ìš”."
