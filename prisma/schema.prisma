generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        BigInt      @id @default(autoincrement())
  email     String?  @unique // 소셜로그인 시 이메일이 없을 수 있으므로 Nullable
  name      String?

  // 소셜 로그인 정보
  snsId     String?  // 일반 가입 시에는 snsId가 없으므로 Nullable
  provider  String?  // 일반 가입 시에는 provider가 없으므로 Nullable

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  gameSessions GameSession[]

  // 소셜 로그인 사용자를 위한 복합 고유 키
  @@unique([snsId, provider])
  @@map("users")
}

model GameSession {
  id           BigInt      @id @default(autoincrement())
  userId       BigInt
  currentActId BigInt?
  createdAt    DateTime @default(now())

  user                User                 @relation(fields: [userId], references: [id])
  currentAct          Act?                 @relation(fields: [currentActId], references: [id])
  inventories         Inventory[]
  playingCharacterSet PlayingCharacterSet?

  @@map("game_sessions")
}

model Inventory {
  id            BigInt @id @default(autoincrement())
  gameSessionId BigInt
  bagId         BigInt?

  gameSession GameSession @relation(fields: [gameSessionId], references: [id])
  bag         Bag?        @relation(fields: [bagId], references: [id])
  slots       Slot[]

  @@map("inventories")
}

model Item {
  id             BigInt      @id @default(autoincrement()) @map("ItemID")
  name           String   @map("ItemName")
  image          String?  @map("ItemImage")
  capacityCost   Int?     @map("CapacityCost")
  isConsumable   Boolean? @map("IsConsumable")
  storeSection   StoreSection? @map("StoreSection")
  isVisable      Boolean? @map("IsVisable")
  itemCategoryId BigInt?  @map("ItemCategoryID")
  necessity      Int?     @map("필요도")

  itemCategory ItemCategory? @relation(fields: [itemCategoryId], references: [id])
  slots        Slot[]

  @@map("items")
}

model PlayingCharacterSet {
  id               BigInt    @id @default(autoincrement())
  gameSessionId    BigInt    @unique
  characterGroupId BigInt?

  gameSession      GameSession       @relation(fields: [gameSessionId], references: [id])
  characterGroup   CharacterGroup?   @relation(fields: [characterGroupId], references: [id])
  playingCharacter PlayingCharacter[]

  @@map("playing_character_sets")
}

model Slot {
  id       BigInt @id @default(autoincrement())
  invId    BigInt
  itemId   BigInt
  quantity Int

  inventory Inventory @relation(fields: [invId], references: [id])
  item      Item      @relation(fields: [itemId], references: [id])

  @@map("slots")
}

model Character {
  id                 BigInt      @id @default(autoincrement()) @map("CharID")
  name               String?     @map("CharName")
  age                Int?        @map("CharAge")
  description        String?     @map("CharDesc")
  selectImage        String?     @map("CharSelectImage")
  potraitImage       String?     @map("CharPotraitImage")
  defaultHp          Int?        @map("HealthDefault")
  defaultSp          Int?        @map("MentalDefault")
  characterGroupId   BigInt?     @map("CharacterGroupID")
  playingCharacters PlayingCharacter[]

  characterGroup    CharacterGroup? @relation(fields: [characterGroupId], references: [id])

  @@map("characters")
}

model ItemCategory {
  id    BigInt    @id @default(autoincrement()) @map("ItemCategoryID")
  name  String?
  items Item[]

  @@map("item_categories")
}

model PlayingCharacter {
  id                     BigInt @id @default(autoincrement())
  playingCharacterSetId  BigInt
  characterId            BigInt
  currentHp              Int
  currentSp              Int

  playingCharacterSet PlayingCharacterSet @relation(fields: [playingCharacterSetId], references: [id])
  character           Character           @relation(fields: [characterId], references: [id])

  @@map("playing_characters")
}

model Act {
  id                      BigInt           @id @default(autoincrement())
  text                    String           @db.Text
  events                  Event[]
  game_sessions           GameSession[]
  prologForCharacterGroup CharacterGroup[]

  @@map("acts")
}

model Event {
  id        BigInt    @id @default(autoincrement())
  actId     BigInt
  eventType EventType @map("EventType")
  order     Int
  speaker   String
  script    String    @db.Text
  position  String
  emotion   String
  bgImage   String
  act         Act       @relation(fields: [actId], references: [id])

  @@map("events")
}


model Bag {
  id          BigInt      @id @default(autoincrement()) @map("BagID")
  name        String?     @map("BagName")
  image       String?     @map("BagImageName")
  capacity    Int?        @map("Capacity")
  inventories Inventory[]

  @@map("bags")
}

model CharacterGroup {
  id                  BigInt                  @id @default(autoincrement()) @map("GroupID")
  name                String?                 @map("GroupName")
  image               String?                 @map("GroupSelectImage")
  deathEndAct         Int?                    @map("DeathEndAct")
  description         String?                 @map("Description")
  prologActId         BigInt?
  prologAct           Act?                    @relation(fields: [prologActId], references: [id])
  playingCharacterSet PlayingCharacterSet[]
  characters          Character[]

  @@map("character_groups")
}

enum StoreSection {
  GroupGrocery
  GroupElectronics
  GroupDrugstore
  GroupSale
  GroupHousehold
  GroupToy
  GroupApparel
  NoStore
}

enum EventType {
  Simple
  System
  StoryChoice
  ItemChoice
  Status
}